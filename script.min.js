var map,pathPoints,giantMarker,centerMarker,userMarker,dayPath,startMarker,finishMarker,startTimePopup,yourPositionPopup,giantsPositionPopup,dateSelect,restingMessage,watchID,markers=[],centro=[42.81690537406873,-1.6432940644729581];function changeLan(e){var t="",a="",n="",o=dateSelect.value;o||(o=getDay()),dateSelect.innerHTML="","cas"==e&&(t="¿Dónde está la comparsa?",a="Recorridos de la comparsa de gigantes y cabezudos en San Fermin 2024",n="Recorrido del día",startTimePopup="Salida ",yourPositionPopup="Tu posición",giantsPositionPopup="Posición estimada de la comparsa",dateSelect.add(new Option("6 de julio","6")),dateSelect.add(new Option("7 de julio","7")),dateSelect.add(new Option("8 de julio","8")),dateSelect.add(new Option("9 de julio","9")),dateSelect.add(new Option("10 de julio","10")),dateSelect.add(new Option("11 de julio","11")),dateSelect.add(new Option("12 de julio","12")),dateSelect.add(new Option("13 de julio","13")),dateSelect.add(new Option("14 de julio","14")),restingMessage="Ahora mismo los gigantes y cabezudos están descansando!"),"eus"==e&&(t="Non dago konpartsa?",a="Erraldoi eta buruhandien konpartsaren ibilbidea 2024ko San Ferminetan",n="Eguneko ibilbidea",startTimePopup="Irteera ",yourPositionPopup="Zure posizioa",giantsPositionPopup="Konpartsaren posizio estimatua",dateSelect.add(new Option("Uztailak 6","6")),dateSelect.add(new Option("Uztailak 7","7")),dateSelect.add(new Option("Uztailak 8","8")),dateSelect.add(new Option("Uztailak 9","9")),dateSelect.add(new Option("Uztailak 10","10")),dateSelect.add(new Option("Uztailak 11","11")),dateSelect.add(new Option("Uztailak 12","12")),dateSelect.add(new Option("Uztailak 13","13")),dateSelect.add(new Option("Uztailak 14","14")),restingMessage="Oraintxe erraldoiak eta buru handiak atseden hartzen ari dira!"),"eng"==e&&(t='Where are the "comparsa"',a="Tour of the troupe of giants and big heads in San Fermin 2024",n="Tour of the day",startTimePopup="Departure ",yourPositionPopup="Your position",giantsPositionPopup="Estimated position of the troupe",dateSelect.add(new Option("July 6th","6")),dateSelect.add(new Option("July 7th","7")),dateSelect.add(new Option("July 8th","8")),dateSelect.add(new Option("July 9th","9")),dateSelect.add(new Option("July 10th","10")),dateSelect.add(new Option("July 11th","12")),dateSelect.add(new Option("July 12th","12")),dateSelect.add(new Option("July 13th","13")),dateSelect.add(new Option("July 14th","14")),restingMessage="Right now the giants and big heads are resting!"),dateSelect.value=o,document.getElementById("subtitle").innerText=a,document.getElementById("title").innerText=t,document.getElementById("path").innerText=n,null!=userMarker&&userMarker.bindPopup(yourPositionPopup),null!=startMarker&&(setStartTime(getDay()),startMarker.bindPopup(startTimePopup))}function request(e,t,a,n,o){$.ajax({url:e,type:t,data:a,success:function(e){n(e)},error:function(e){o(e)}})}function calcDistance(e,t,a,n){const o=Math.PI/180,i=.5-Math.cos((a-e)*o)/2+Math.cos(e*o)*Math.cos(a*o)*(1-Math.cos((n-t)*o))/2;return 12742e3*Math.asin(Math.sqrt(i))}function calcGapPointsFromPath(e,t){var a=[],n=0;if(markers)for(var o=0;o<markers.length;o++)map.removeLayer(markers[o]);for(o=0;o<e.length;o++){var i=e[o-1],r=e[o],l=calcDistance(i.lat,i.lng,r.lat,r.lng),d=(l-n)/t,s=1;a.push(i),a.push(r);var p=L.marker([i.lat,i.lng]).addTo(map),u=L.marker([r.lat,r.lng]).addTo(map);for(markers.push(p),markers.push(u);l>t*s;){var c={lat:i.lat+(r.lat-i.lat)/d*s,lng:i.lng+(r.lng-i.lng)/d*s};a.push(c);var g=L.marker([c.lat,c.lng]).addTo(map);markers.push(g),s++}n=calcDistance(a[a.length-1].lat,a[a.length-1].lng,r.lat,r.lng)}return a}function drawTodayPath(e){request("index.php/path","POST",{day:e},(function(t){if(null!=dayPath&&(map.removeLayer(dayPath),map.removeLayer(startMarker),map.removeLayer(finishMarker)),t&&0!=t.length){pathPoints=t,dayPath=L.polyline(pathPoints,{color:"#cc3333",weight:5}).addTo(map);var a=pathPoints[0],n=pathPoints[pathPoints.length-1];startMarker=L.marker([a.lat,a.lng],{icon:L.icon({iconUrl:"inicio.png",iconSize:[32,32],popupAnchor:[0,-10]})}).addTo(map),finishMarker=L.marker([n.lat,n.lng],{icon:L.icon({iconUrl:"final.png",iconSize:[32,32]})}).addTo(map),setStartTime(e),startTimePopup&&startMarker.bindPopup(startTimePopup).openPopup(),setCenterAndZoom()}}),(function(e){console.log(e)}))}function moveGiantMarker(e,t){if(null==giantMarker){var a=L.icon({iconUrl:"king.png",iconSize:[64,64],className:"blinking",popupAnchor:[0,-30]});(giantMarker=L.marker([e,t],{icon:a}).addTo(map)).bindPopup(giantsPositionPopup).openPopup(),setCenterAndZoom()}else giantMarker.setLatLng([e,t])}function subscribeGiantPosition(){gigantesBailando()?null!=giantMarker?(map.removeLayer(giantMarker),giantMarker=null,setCenterAndZoom()):(getGiantPosition(),setInterval((function(){getGiantPosition()}),1e4)):alert(restingMessage)}function getGiantPosition(){request("index.php/position","POST",{day:getDay(),date:(new Date).toISOString()},(function(e){moveGiantMarker(Number(e.lat),Number(e.lon))}),(function(e){console.log(e)}))}function subscribeUserPosition(){"geolocation"in navigator?watchID?(navigator.geolocation.clearWatch(watchID),map.removeLayer(userMarker),userMarker=null,watchID=null,setCenterAndZoom()):watchID=navigator.geolocation.watchPosition((e=>{var t=[e.coords.latitude,e.coords.longitude];if(null==userMarker){var a=L.icon({iconUrl:"user.png",iconSize:[64,64],className:"blinking",popupAnchor:[0,-30]});(userMarker=L.marker(t,{icon:a}).addTo(map)).bindPopup(yourPositionPopup).openPopup(),setCenterAndZoom()}else userMarker.setLatLng(t)})):alert("Geolocalicacion no disponible")}function setCenterAndZoom(){var e=[];null!=giantMarker&&e.push(giantMarker.getLatLng()),null!=userMarker&&e.push(userMarker.getLatLng()),null!=centerMarker&&e.push(centerMarker.getLatLng()),null!=startMarker&&e.push(startMarker.getLatLng()),null!=finishMarker&&e.push(finishMarker.getLatLng()),null!=pathPoints&&e.push(pathPoints),map.fitBounds(e)}function privacidadModal(){}function gigantesBailando(){var e=(new Date).getTime();return e>new Date(2024,6,6,17,0)&&e<new Date(2024,6,6,21,0)||e>new Date(2024,6,7,9,30)&&e<new Date(2024,6,7,15,0)||e>new Date(2024,6,8,9,30)&&e<new Date(2024,6,8,15,0)||e>new Date(2024,6,9,9,30)&&e<new Date(2024,6,9,15,0)||e>new Date(2024,6,10,9,30)&&e<new Date(2024,6,10,15,0)||e>new Date(2024,6,11,9,30)&&e<new Date(2024,6,11,15,0)||e>new Date(2024,6,12,9,30)&&e<new Date(2024,6,12,15,0)||e>new Date(2024,6,13,9,30)&&e<new Date(2024,6,13,15,0)||e>new Date(2024,6,14,9,30)&&e<new Date(2024,6,14,15,0)}function setStartTime(e){startTimePopup=6==e?startTimePopup.split(" ")[0]+" 17:00":startTimePopup.split(" ")[0]+" 9:30"}function getDay(){var e=(new Date).getTime();return e<new Date("07/07/2024")?6:e>new Date("14/07/2024")?14:(new Date).getDate()}function addUserLocalizationControl(){L.Control.Button=L.Control.extend({options:{position:"topleft"},onAdd:function(e){var t=L.DomUtil.create("div","leaflet-bar leaflet-control"),a=L.DomUtil.create("a","leaflet-control-button",t);return L.DomUtil.create("img","",a).src="user.png",L.DomEvent.disableClickPropagation(a),L.DomEvent.on(a,"click",(function(){subscribeUserPosition()})),t},onRemove:function(e){}}),(new L.Control.Button).addTo(map)}function addGiantsLocalizationControl(){L.Control.Button=L.Control.extend({options:{position:"topleft"},onAdd:function(e){var t=L.DomUtil.create("div","leaflet-bar leaflet-control"),a=L.DomUtil.create("a","leaflet-control-button",t);return L.DomUtil.create("img","",a).src="king.png",L.DomEvent.disableClickPropagation(a),L.DomEvent.on(a,"click",(function(){subscribeGiantPosition()})),t},onRemove:function(e){}}),(new L.Control.Button).addTo(map)}function init(){map=L.map("map"),L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(map),(dateSelect=document.getElementById("dateSelect")).addEventListener("change",(function(){drawTodayPath(Number(this.value))})),changeLan("cas"),drawTodayPath(getDay()),addUserLocalizationControl(),addGiantsLocalizationControl()}window.onload=init;